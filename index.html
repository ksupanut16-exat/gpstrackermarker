<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPS Tracker + Google Sheets Debug</title>

  <!-- ✅ Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+4b8Kz0D0WfTgkUJbJQ7FQ0vFv7pnhM7Nf1pA+Z1w="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100vh; width: 100%; }

    .status-bar {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="status" class="status-bar">🕓 รอเริ่มติดตาม...</div>

  <!-- ✅ Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGStG2zYw2x+hG3WZBeb5lL1zGPEz3T2oCjHc="
    crossorigin=""
  ></script>

  <script>
    window.onload = () => {
      console.log("🚀 เริ่มต้นโหลดแผนที่...");

      // ✅ ตรวจว่า Leaflet โหลดสำเร็จไหม
      if (typeof L === "undefined") {
        console.error("❌ Leaflet ยังไม่ถูกโหลด กรุณาตรวจสอบลิงก์ JS/CSS");
        return;
      }

      // ✅ สร้างแผนที่
      const map = L.map('map').setView([13.736717, 100.523186], 13);
      console.log("🗺️ แผนที่ถูกสร้างแล้ว");

      // ✅ โหลดแผนที่จาก OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // ✅ แสดงข้อความสถานะ
      const statusEl = document.getElementById("status");
      statusEl.innerHTML = "🗺️ แผนที่พร้อมแล้ว กำลังโหลดข้อมูลจาก Google Sheets...";

      // ✅ โหลดข้อมูลจาก Google Sheets
      const sheetID = "1KTFaGCzmtjJtezumsWDXFdsWlpZtSriq2mEHe-ujGNc";
      const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

      console.log("📡 กำลังโหลดข้อมูลจาก:", sheetURL);

      fetch(sheetURL)
        .then(res => res.text())
        .then(text => {
          console.log("✅ โหลดข้อมูลจาก Google Sheets สำเร็จ");

          // ตรวจว่าข้อมูล JSON ถูกต้องไหม
          if (!text.startsWith("/*O_o*/")) {
            console.error("❌ รูปแบบข้อมูลจาก Google Sheets ไม่ถูกต้อง");
            console.log(text);
            statusEl.innerHTML = "❌ โหลดข้อมูลไม่สำเร็จ — โปรดตรวจว่าได้ 'Publish to the web' แล้ว";
            return;
          }

          // ตัด prefix/suffix ออกก่อน parse
          const json = JSON.parse(text.substring(47).slice(0, -2));
          const rows = json.table.rows;
          console.log(`📊 พบข้อมูลทั้งหมด ${rows.length} แถว`);

          rows.forEach(r => {
            const name = r.c[0]?.v;
            const lat = r.c[1]?.v;
            const lng = r.c[2]?.v;
            const lastRepair = r.c[3]?.v;
            const job = r.c[4]?.v;
            const tech = r.c[5]?.v;
            const photo = r.c[6]?.v;
            const report = r.c[7]?.v;
            const status = r.c[8]?.v || "";

            if (lat && lng) {
              let color = "blue";

              // 🔶 SPxx = เหลือง
              if (/^SP\d+/i.test(status)) color = "yellow";
              // 💗 HMxx = ชมพู
              else if (/^HM\d+/i.test(status)) color = "pink";
              // 🟢 เสร็จแล้ว
              else if (/เสร็จ/i.test(status)) color = "green";
              // 🟠 กำลังทำ
              else if (/กำลัง/i.test(status)) color = "orange";
              // 🔴 ยังไม่เริ่ม
              else if (/ยังไม่/i.test(status)) color = "red";

              const icon = L.divIcon({
                html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid white;"></div>`,
                className: ""
              });

              const popup = `
                <b>${name}</b><br>
                📅 ${lastRepair || "-"}<br>
                🛠️ ${job || "-"}<br>
                👷 ${tech || "-"}<br>
                📸 <a href="${photo}" target="_blank">รูปถ่าย</a><br>
                📄 <a href="${report}" target="_blank">ใบแจ้งงาน</a><br>
                🔰 สถานะ: <b>${status || "-"}</b>
              `;

              L.marker([lat, lng], { icon }).addTo(map).bindPopup(popup);
            }
          });

          statusEl.innerHTML = "✅ โหลดข้อมูลจาก Google Sheets สำเร็จ";
        })
        .catch(err => {
          console.error("❌ โหลดข้อมูลจาก Google Sheets ล้มเหลว:", err);
          statusEl.innerHTML = "❌ โหลดข้อมูลจาก Google Sheets ไม่สำเร็จ — ดูใน Console";
        });
    };
  </script>
</body>
</html>
