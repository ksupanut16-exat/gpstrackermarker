<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPS Tracker + Google Sheets Debug</title>

  <!-- âœ… Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+4b8Kz0D0WfTgkUJbJQ7FQ0vFv7pnhM7Nf1pA+Z1w="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100vh; width: 100%; }

    .status-bar {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="status" class="status-bar">ğŸ•“ à¸£à¸­à¹€à¸£à¸´à¹ˆà¸¡à¸•à¸´à¸”à¸•à¸²à¸¡...</div>

  <!-- âœ… Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGStG2zYw2x+hG3WZBeb5lL1zGPEz3T2oCjHc="
    crossorigin=""
  ></script>

  <script>
    window.onload = () => {
      console.log("ğŸš€ à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹‚à¸«à¸¥à¸”à¹à¸œà¸™à¸—à¸µà¹ˆ...");

      // âœ… à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸² Leaflet à¹‚à¸«à¸¥à¸”à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹„à¸«à¸¡
      if (typeof L === "undefined") {
        console.error("âŒ Leaflet à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¹à¸à¹‚à¸«à¸¥à¸” à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸¥à¸´à¸‡à¸à¹Œ JS/CSS");
        return;
      }

      // âœ… à¸ªà¸£à¹‰à¸²à¸‡à¹à¸œà¸™à¸—à¸µà¹ˆ
      const map = L.map('map').setView([13.736717, 100.523186], 13);
      console.log("ğŸ—ºï¸ à¹à¸œà¸™à¸—à¸µà¹ˆà¸–à¸¹à¸à¸ªà¸£à¹‰à¸²à¸‡à¹à¸¥à¹‰à¸§");

      // âœ… à¹‚à¸«à¸¥à¸”à¹à¸œà¸™à¸—à¸µà¹ˆà¸ˆà¸²à¸ OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // âœ… à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°
      const statusEl = document.getElementById("status");
      statusEl.innerHTML = "ğŸ—ºï¸ à¹à¸œà¸™à¸—à¸µà¹ˆà¸à¸£à¹‰à¸­à¸¡à¹à¸¥à¹‰à¸§ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Google Sheets...";

      // âœ… à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Google Sheets
      const sheetID = "1KTFaGCzmtjJtezumsWDXFdsWlpZtSriq2mEHe-ujGNc";
      const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

      console.log("ğŸ“¡ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸:", sheetURL);

      fetch(sheetURL)
        .then(res => res.text())
        .then(text => {
          console.log("âœ… à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Google Sheets à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");

          // à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ JSON à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¹„à¸«à¸¡
          if (!text.startsWith("/*O_o*/")) {
            console.error("âŒ à¸£à¸¹à¸›à¹à¸šà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Google Sheets à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡");
            console.log(text);
            statusEl.innerHTML = "âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ â€” à¹‚à¸›à¸£à¸”à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸²à¹„à¸”à¹‰ 'Publish to the web' à¹à¸¥à¹‰à¸§";
            return;
          }

          // à¸•à¸±à¸” prefix/suffix à¸­à¸­à¸à¸à¹ˆà¸­à¸™ parse
          const json = JSON.parse(text.substring(47).slice(0, -2));
          const rows = json.table.rows;
          console.log(`ğŸ“Š à¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” ${rows.length} à¹à¸–à¸§`);

          rows.forEach(r => {
            const name = r.c[0]?.v;
            const lat = r.c[1]?.v;
            const lng = r.c[2]?.v;
            const lastRepair = r.c[3]?.v;
            const job = r.c[4]?.v;
            const tech = r.c[5]?.v;
            const photo = r.c[6]?.v;
            const report = r.c[7]?.v;
            const status = r.c[8]?.v || "";

            if (lat && lng) {
              let color = "blue";

              // ğŸ”¶ SPxx = à¹€à¸«à¸¥à¸·à¸­à¸‡
              if (/^SP\d+/i.test(status)) color = "yellow";
              // ğŸ’— HMxx = à¸Šà¸¡à¸à¸¹
              else if (/^HM\d+/i.test(status)) color = "pink";
              // ğŸŸ¢ à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§
              else if (/à¹€à¸ªà¸£à¹‡à¸ˆ/i.test(status)) color = "green";
              // ğŸŸ  à¸à¸³à¸¥à¸±à¸‡à¸—à¸³
              else if (/à¸à¸³à¸¥à¸±à¸‡/i.test(status)) color = "orange";
              // ğŸ”´ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸£à¸´à¹ˆà¸¡
              else if (/à¸¢à¸±à¸‡à¹„à¸¡à¹ˆ/i.test(status)) color = "red";

              const icon = L.divIcon({
                html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid white;"></div>`,
                className: ""
              });

              const popup = `
                <b>${name}</b><br>
                ğŸ“… ${lastRepair || "-"}<br>
                ğŸ› ï¸ ${job || "-"}<br>
                ğŸ‘· ${tech || "-"}<br>
                ğŸ“¸ <a href="${photo}" target="_blank">à¸£à¸¹à¸›à¸–à¹ˆà¸²à¸¢</a><br>
                ğŸ“„ <a href="${report}" target="_blank">à¹ƒà¸šà¹à¸ˆà¹‰à¸‡à¸‡à¸²à¸™</a><br>
                ğŸ”° à¸ªà¸–à¸²à¸™à¸°: <b>${status || "-"}</b>
              `;

              L.marker([lat, lng], { icon }).addTo(map).bindPopup(popup);
            }
          });

          statusEl.innerHTML = "âœ… à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Google Sheets à¸ªà¸³à¹€à¸£à¹‡à¸ˆ";
        })
        .catch(err => {
          console.error("âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Google Sheets à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:", err);
          statusEl.innerHTML = "âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Google Sheets à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ â€” à¸”à¸¹à¹ƒà¸™ Console";
        });
    };
  </script>
</body>
</html>
